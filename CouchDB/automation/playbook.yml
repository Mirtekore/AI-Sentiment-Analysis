---
- name: Install docker and start single node couchDB.
  hosts: couchdb
  become: true
  vars:
    couchdb_version: "3.2.1"
    docker_users:
      - "ubuntu"

  tasks:
    # Check before installation
    - community.docker.docker_compose:
        project_src: couchdb_docker
        state: absent

    - community.docker.docker_compose:
        project_name: couchdb_docker
        definition:
          db:
            image: ibmcom/couchdb3:3.2.1
            volumes:
              - couchdb_node1_data:/opt/couchdb/data
            ports:
              - 5984:5984
              - 4369:4369
              - 9100:9100
            restart: always
            environment:
              # # TODO: don't use plaintext, use ansible vault
              - COUCHDB_USER=admin
              - COUCHDB_PASSWORD=admin
              - NODENAME={{hostvars[inventory_hostname]['ansible_default_ipv4']['address']}}
            expose:
              - 5984
      register: output

    # - name: Start the couchDB container
    #   community.docker.docker_compose:
    #     project_src: couchdb_docker
    #   register: output

    # - name: Check that you can connect (GET) to a page and it returns a status 200
    #   ansible.builtin.uri:
    #     url: http://127.0.0.1:5984
    #     method: POST
    # url_username: "admin"
    # url_password: "admin"

    # - name: Contact the masternode and initiate cluster creation
    #   uri:
    #     url: http://127.0.0.1:5984
    #     url_username: "admin"
    #     url_password: "admin"
    #     body: "{{ lookup('file','initiate_cluster.json') }}"
    #     method: POST
    #     body_format: json
    #     headers:
    #       Content-Type: "application/json"
    #       X-Application-Username: "admin"
    #       X-Application-Password: "admin"

    # - name: Inform the masternode of the additional node
    #   uri:
    #     url: http://127.0.0.1:5984
    #     body: "{{ lookup('file','add_node.json') }}"
    #     method: POST
    #     body_format: json
    #     headers:
    #       Content-Type: "application/json"

    # - name: Finish the cluster setup with the masternode
    #   uri:
    #     url: http://127.0.0.1:5984
    #     url_username: "admin"
    #     url_password: "admin"
    #     body: "{{ lookup('file','finish_cluster.json') }}"
    #     method: POST
    #     body_format: json
    #     headers:
    #       Content-Type: "application/json"
